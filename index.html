<!doctype html><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<body>
  <div id="app">起動中…</div>
<script>
const LIFF_ID = "2008180210-1WyAevA4";
const GAS_API = "https://script.google.com/macros/s/AKfycbwWUFUpNkNC7zp6CnVCxN-jwqLt0KAEBXNtdgvM8rFb5xMjMJs9x-WZ3pZp32trAwRn/exec";

const app = document.getElementById('app');
// ローディング表示（経過時間つき）
app.innerHTML = `
  <div>
    <div>Googleフォームを読み込み中…</div>
    <div>6秒程度かかります．しばらくお待ちください．</div>
    <div>経過時間：<span id="elapsed">0</span> 秒</div>
  </div>
`;
const t0 = performance.now();
const updateElapsed = () => {
  const sec = ((performance.now() - t0) / 1000).toFixed(1);
  const el = document.getElementById('elapsed');
  if (el) el.textContent = sec;
};
const timerId = setInterval(updateElapsed, 100);
updateElapsed();

(async () => {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login({ scope:'openid profile', prompt:'consent' }); return; }

    const idToken = liff.getIDToken();
    if (!idToken) { liff.login({ scope:'openid profile', prompt:'consent' }); return; }

    // ユーザID取得
    const prof = await liff.getProfile();
    const lineUserId = prof.userId;

    // liff.state と直URLの両方に対応
    const url = new URL(location.href);
    let form = null, mealType = null;
    if (url.searchParams.has('liff.state')) {
      const state = decodeURIComponent(url.searchParams.get('liff.state'));
      const qs = state.includes('?') ? state.split('?')[1] : state;
      const sp = new URLSearchParams(qs);
      form = sp.get('form');
      mealType = sp.get('mealType');
    } else {
      const sp = url.searchParams;
      form = sp.get('form');
      mealType = sp.get('mealType');
    }

    if (form) {
      const body = new URLSearchParams({ action:"mint", form, idToken, lineUserId });
      if (mealType) body.set("mealType", mealType);

      const res = await fetch(GAS_API, {
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded" },
        body
      });
      const { ok, prefillUrl, error } = await res.json();
      if (!ok) throw new Error(error || "API error");

      clearInterval(timerId);
      location.href = prefillUrl; // フォームへ遷移
    } else {
      clearInterval(timerId);
      app.innerHTML = `<p>メニューから選択してください．</p>`;
    }
  } catch (e) {
    clearInterval(timerId);
    app.innerHTML = `<p>読み込み中にエラーが発生しました．${(e && e.message) ? e.message : e}．</p>`;
    console.error(e);
  }
})();
</script>
</body>
