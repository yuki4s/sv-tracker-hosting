<!doctype html><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<body><div id="app">起動中…</div>
<script>
const LIFF_ID = "2008180210-1WyAevA4";
const GAS_API = "https://script.google.com/macros/s/AKfycbwWUFUpNkNC7zp6CnVCxN-jwqLt0KAEBXNtdgvM8rFb5xMjMJs9x-WZ3pZp32trAwRn/exec";

(async () => {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) { liff.login({ scope:'openid profile', prompt:'consent' }); return; }
  const idToken = liff.getIDToken(); if (!idToken) { liff.login({ scope:'openid profile', prompt:'consent' }); return; }

  // ユーザID取得（profileスコープでOK）
  const prof = await liff.getProfile();              // displayName等も取得可
  const lineUserId = prof.userId;                    // ← これをGASへ送る（画像Webhookと突合する鍵） :contentReference[oaicite:1]{index=1}

  // --- ここがポイント：liff.state を見る ---
  const url = new URL(location.href);
  let form = null, mealType = null;

  if (url.searchParams.has('liff.state')) {
    // 例: liff.state="/index.html?form=weight&mealType=breakfast"
    const state = decodeURIComponent(url.searchParams.get('liff.state'));
    const qs = state.includes('?') ? state.split('?')[1] : state; // "?..." または "key=val..." の両方に対応
    const sp = new URLSearchParams(qs);
    form = sp.get('form');
    mealType = sp.get('mealType');
  } else {
    // 直接エンドポイントに来た場合（GitHub Pages のURLに ?form=... を付けたとき等）
    const sp = url.searchParams;
    form = sp.get('form');
    mealType = sp.get('mealType');
  }

  // form が取れたらそのままミントして遷移
  if (form) {
    const body = new URLSearchParams({ action:"mint", form, idToken });
    if (mealType) body.set("mealType", mealType);
    // lineUserIdを同時送信
    body.set("lineUserId", lineUserId);

    const res = await fetch(GAS_API, { method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded" }, body });
    const { ok, prefillUrl, error } = await res.json();
    if (!ok) throw new Error(error || "API error");
    location.href = prefillUrl;
  } else {
    // フォールバック（任意）：メニュー表示
    document.body.innerHTML = `<p>メニューから選択してください</p>`;
  }
})();
</script>
</body>
