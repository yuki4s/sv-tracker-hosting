<!doctype html><meta charset="utf-8">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<body><p id="s">loading…</p><script>
const CONFIGS = {
  meal: {
    formPrefillUrl: 'https://docs.google.com/forms/d/e/1FAIpQLSfsFIsPh8z71THfilhJAr4aOWkMa-cmxTVwlSitu4MdOzhnUA/viewform?usp=pp_url',
    entryTokenKey: 'entry.208491577'   // meal用「token」設問のフルキー
  },
  weight: {
    formPrefillUrl: 'https://docs.google.com/forms/d/e/.../viewform?usp=pp_url', // 要編集
    entryTokenKey: 'entry.222222222'   // weight用「token」設問のフルキー
  }
};

const ISSUE_API = 'https://script.google.com/macros/s/AKfycbxWLL37SVeYLS86fAioZEikNWywGpmcC_HPIK_pR31i5_iXlz_a0JXbz0Yu7n4/exec?route=issue'

(async () => {
  try {
    await liff.init({ liffId: '2008180210-1WyAevA4' });
    if (!liff.isLoggedIn()) { liff.login({ redirectUri: location.href }); return; }

    const idToken = liff.getIDToken();
    if (!idToken) throw new Error('ID token unavailable');

    const qs = new URLSearchParams(location.search);
    const which = (qs.get('form') || 'meal').toLowerCase();
    const cfg = CONFIGS[which] || CONFIGS.meal;

    // ★GitHubにPOSTしない。GASの /exec?route=issue にPOSTする
    const body = new URLSearchParams({ idToken, form: which }).toString();
    const res  = await fetch(ISSUE_API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body
    });
    const { token } = await res.json();
    if (!token) throw new Error('token issue failed');

    const url = new URL(cfg.formPrefillUrl);
    url.searchParams.set(cfg.entryTokenKey, token);
    liff.openWindow({ url: url.toString(), external: false });
  } catch (e) {
    document.getElementById('s').textContent = 'Error: ' + (e.message || e);
  }
})();
</script></body>